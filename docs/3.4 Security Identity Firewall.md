# Security - Identity Firewall 

## Introduction

In this section, we will go through how to configure and test the NSX
Identity Firewall (IDFW) capabilities for micro-segmentation. Identity Firewall with NSX-T Data Center, just like Distributed Firewall, does not require Overlay networking and can be done on a VLAN-backed
Segment. The following example will use Overlay networking but note this
is not a requirement.

NSX-T IDFW works for both single user and multi-user (Microsoft Remote Desktop Server Host) use cases. 

## Security - Identity Firewall Requirements

The following items are required before the Identity Firewalling functionality can be utilized. 

1. [NSX Requirements](/docs/1-Requirements.md)
2. [NSX Installation](/docs/2-Installation.md)
3. [Microsoft Active Directory supported version](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/3.0/administration/GUID-9CD3FC21-9ED4-4FB3-9E19-67A7C4D1F53E.html#GUID-9CD3FC21-9ED4-4FB3-9E19-67A7C4D1F53E)
    - Active Directory with 2016 Functional Level is used in this example
4.  LDAP User account with read access to the Active Directory
5.  Base DN of the domain
    - Domain = **Corp.local** | Base DN = **dc=corp,dc=local**
4.  Two (2) User accounts in Active Directory that can be used to test IDFW Security Policy configurations
    - HR User - **Corp\Bob** 
    - Engineering User - **Corp\Alice**
6.  [Virtual Machine with supported Windows Operating System](https://docs.vmware.com/en/VMware-NSX-T-Data-Center/3.0/administration/GUID-9CD3FC21-9ED4-4FB3-9E19-67A7C4D1F53E.html#GUID-9CD3FC21-9ED4-4FB3-9E19-67A7C4D1F53E)
    - If using Windows Server 2012R2 or 2016 for RDSH, [RDSH role needs to be installed and properly licensed](https://support.microsoft.com/en-us/help/2833839/guidelines-for-installing-the-remote-desktop-session-host-role-service)
    - Windows Server 2016 with Remote Desktop Services Host Role is used in this example
7.  [VMware Tools version supported](https://www.vmware.com/resources/compatibility/sim/interop_matrix.php#interop&175=&139=)
    - VMware Tools requires: (Easier to do a 'Complete' installation of VMware Tools, which includes the below drivers)
        - VMCI Driver Installed
        - NSX File Introspection Driver Installed
        - NSX Network Introspection Driver Installed
8.  SSH Client to check IDFW in the ESXi data plane
    - **Putty** will be used in this example
9.  PowerShell with Active Directory plugin to check Active Directory Group SID
10.  Destination server to test connectivity allow and drop with IDFW based on user
    - SSH Access to a Web server will be used in this example

## Security - Identity Firewall Proof of Concept Use Cases Demonstrated

**Single-User IDFW Use Case**
- Alice, from the Engineering department, will use Remote Desktop Protocol to access the RDSH Server
- Alice and will be granted access to the Web Server to be able to access SSH and perform administrative tasks
- Alice will attempt access to the HR Web Site and be denied

**Multi-User IDFW Use Case**
- Bob, from the HR department, will use Remote Desktop Protocol to access the same RDSH Server Alice is logged into
- Bob will be allowed to access the HR Web Application hosted on a Web Server
- Bob will attempt access to SSH to the Web Server hosting the HR Web Application and be denied

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW_topology.png>
</p>

## Security - Identity Firewall Configuration

### Add Active Directory to NSX-T Manager

The NSX-T IDFW needs to connect to Microsoft Active Directory to pull in AD Security Group information for use in NSX-T Security Policy configurations.

1. Log into the NSX-T Manager and navigate to **System > Identity Firewall AD > Active Directory** and click **ADD ACTIVE DIRECTORY**
2. Name - **CORP.LOCAL**
3. NetBIOS Name - **CORP**
4. Base Distinguished Name - **dc=corp,dc=local**
5. Click on **LDAP Server Set**

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW.step1.png>
</p>


6. Host - **192.168.110.10** (IP Address or FQDN of Active Directory Domain Controller)
7. Protocol - **LDAP** or **LDAPS** depending on your configuration
8. Port - **389** or **636** depending on LDAP or LDAPS
9. Username - **admin** (LDAP Read-Only Account from requirements)
10. Password - **REDACTED** (LDAP Read-Only Account password from requirements)
11. Click **ADD**
12. Click **APPLY**

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW.step2.png>
</p>

### Enable IDFW

The NSX-T IDFW needs to be enabled on either a standalone VMware ESXi host or cluster of ESXi hosts where the VMs where the users will login will reside.

1. Navigate in the NSX-T Manager user interface to **Security > Distributed Firewall**
2. Notice the yellow banner mentioning that the Identity Firewall is disabled
3. Click on the **Enable** link on the banner.  If this banner is not shown, click on the **Actions > General Settings** and this will take you to the same location as the banner link

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW.step3.png>
</p>

4. Click the slider to set **Identity Firewall Status** to **Enable**
5. Click on Identity Firewall Settings
6. Click on the slider for the cluster where IDFW will be **Enabled**
7. Save

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW.step4.png>
</p>

<p align="center">
    <img src=/docs/assets/Graphics/IDFW/IDFW.step5.png>
</p>

